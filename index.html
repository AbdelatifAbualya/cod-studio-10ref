<!-- FILE: index.html -->
<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Enhanced AI Reasoning Studio (Chain of Draft)</title>
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Marked.js for Markdown parsing -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  
  <!-- Highlight.js for code highlighting -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
  
  <!-- Configuration for Tailwind -->
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#eef2ff',
              100: '#e0e7ff',
              200: '#c7d2fe',
              300: '#a5b4fc',
              400: '#818cf8',
              500: '#5686f5',
              600: '#4f46e5',
              700: '#4338ca',
              800: '#3730a3',
              900: '#312e81',
              950: '#1e1b4b',
            },
            dark: {
              100: '#d1d5db',
              200: '#9ca3af',
              300: '#6b7280',
              400: '#4b5563',
              500: '#374151',
              600: '#1f2937',
              700: '#111827',
              800: '#0d1117',
              900: '#030712',
            }
          },
          fontFamily: {
            sans: ['Inter', 'ui-sans-serif', 'system-ui', 'sans-serif'],
            mono: ['JetBrains Mono', 'ui-monospace', 'monospace'],
          },
        }
      }
    };
  </script>

  <style>
    /* Base Styles */
    :root {
      --primary: #5686f5;
      --primary-hover: #4169e1;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
    }
    
    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    
    ::-webkit-scrollbar-track {
      background: rgb(20, 24, 33);
      border-radius: 8px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: rgba(86, 134, 245, 0.6);
      border-radius: 8px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(86, 134, 245, 0.8);
    }

    /* Enhanced Animation Styles */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slideInLeft {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    @keyframes reflectionPulse {
      0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
      70% { transform: scale(1.02); box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
      100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
    }
    
    .problem-analysis {
      animation: fadeIn 0.5s ease;
      border-left: 4px solid #f59e0b;
    }
    
    .cod-step {
      animation: slideInLeft 0.3s ease;
    }
    
    .reflection-box {
      animation: reflectionPulse 2s infinite;
    }
    
    .meta-reflection {
      animation: fadeIn 0.6s ease;
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    }
    
    .final-answer {
      animation: fadeIn 0.7s ease;
      background: linear-gradient(135deg, #065f46 0%, #047857 100%);
    }
    
    /* Streaming Indicator Animation */
    @keyframes typingAnimation {
      0% { border-right-color: rgba(86, 134, 245, 0.7); }
      100% { border-right-color: transparent; }
    }
    
    .streaming {
      border-right: 3px solid rgba(86, 134, 245, 0.7);
      animation: typingAnimation 0.8s infinite ease;
    }
    
    @keyframes ellipsisAnimation {
      0% { content: "."; }
      33% { content: ".."; }
      66% { content: "..."; }
      100% { content: "."; }
    }
    
    .streaming-indicator::after {
      content: "...";
      animation: ellipsisAnimation 1.5s infinite;
    }

    /* Range Slider Styling */
    input[type="range"] {
      -webkit-appearance: none;
      width: 100%;
      height: 4px;
      background: #1f2937;
      border-radius: 4px;
      outline: none;
      background: linear-gradient(to right, var(--primary) var(--value-percent, 50%), #1f2937 var(--value-percent, 50%)) !important;
    }
    
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      background: white !important;
      border-radius: 50%;
      cursor: pointer;
      border: 1px solid rgba(0, 0, 0, 0.1) !important;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      margin-top: -6px;
    }

    /* Progress bar for CoD steps */
    .progress-bar {
      background: linear-gradient(90deg, #3b82f6, #8b5cf6);
      animation: pulse 1.5s infinite;
    }
  </style>
</head>
<body class="bg-dark-800 text-gray-100 font-sans min-h-screen overflow-hidden">
  <div class="flex h-screen">
    <!-- Sidebar -->
    <div class="w-72 bg-dark-700 border-r border-dark-600 flex flex-col p-4 overflow-y-auto hidden md:flex">
      <h2 class="text-xl font-semibold mb-4">Threads</h2>
      <ul id="threadList" class="flex-1 space-y-1 mb-4">
        <li class="bg-dark-600 text-primary-300 px-3 py-2 rounded-md cursor-pointer hover:bg-dark-500 transition">Thread 1</li>
      </ul>
      <div class="space-y-2">
        <button id="newThreadBtn" class="w-full bg-primary-500 hover:bg-primary-600 text-white py-2 px-4 rounded-md transition flex items-center justify-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
          New Thread
        </button>
        <button id="deleteThreadBtn" class="w-full bg-dark-600 hover:bg-dark-500 text-gray-300 py-2 px-4 rounded-md transition">Delete Thread</button>
        <button id="downloadTxtBtn" class="w-full bg-dark-600 hover:bg-dark-500 text-gray-300 py-2 px-4 rounded-md transition">Download TXT</button>
        <button id="clearThreadBtn" class="w-full bg-red-600/20 hover:bg-red-600/30 text-red-400 py-2 px-4 rounded-md transition">Clear Thread</button>
      </div>
    </div>

    <!-- Mobile Sidebar Toggle -->
    <div id="mobileSidebarToggle" class="fixed left-4 top-4 bg-dark-700 p-2 rounded-md shadow-lg z-20 md:hidden">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
      </svg>
    </div>

    <!-- Mobile Sidebar -->
    <div id="mobileSidebar" class="fixed inset-0 bg-dark-800 z-30 transform -translate-x-full transition-transform duration-300 md:hidden">
      <div class="w-full h-full flex flex-col">
        <div class="flex justify-between items-center p-4 border-b border-dark-600">
          <h2 class="text-xl font-semibold">Threads</h2>
          <button id="closeMobileSidebar" class="p-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        <div class="flex-1 p-4 overflow-y-auto">
          <ul id="mobileThreadList" class="space-y-2 mb-4">
            <li class="bg-dark-600 text-primary-300 px-3 py-2 rounded-md cursor-pointer hover:bg-dark-500 transition">Thread 1</li>
          </ul>
          <div class="space-y-2">
            <button id="mobileNewThreadBtn" class="w-full bg-primary-500 hover:bg-primary-600 text-white py-2 px-4 rounded-md transition flex items-center justify-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
              </svg>
              New Thread
            </button>
            <button id="mobileDeleteThreadBtn" class="w-full bg-dark-600 hover:bg-dark-500 text-gray-300 py-2 px-4 rounded-md transition">Delete Thread</button>
            <button id="mobileDownloadTxtBtn" class="w-full bg-dark-600 hover:bg-dark-500 text-gray-300 py-2 px-4 rounded-md transition">Download TXT</button>
            <button id="mobileClearThreadBtn" class="w-full bg-red-600/20 hover:bg-red-600/30 text-red-400 py-2 px-4 rounded-md transition">Clear Thread</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content Area -->
    <div class="flex-1 flex flex-col overflow-hidden">
      <!-- Header -->
      <header class="bg-dark-700 border-b border-dark-600 h-16 flex items-center justify-between px-4 md:px-6">
        <h1 id="pageTitle" class="text-xl font-semibold">Enhanced AI Reasoning Studio (Chain of Draft)</h1>
        <div class="flex items-center gap-3">
          <div id="currentModelDisplay" class="bg-dark-600 text-sm px-3 py-1.5 rounded-lg flex items-center">
            <span>Qwen3-235B (Enhanced CoD)</span>
          </div>
          <button id="openSettings" class="flex items-center gap-1.5 bg-dark-600 hover:bg-dark-500 text-gray-300 px-3 py-1.5 rounded-lg transition">
            <span>Settings</span>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
          </button>
        </div>
      </header>

      <!-- Chat Messages Area -->
      <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-6"></div>

      <!-- Input Area -->
      <div class="p-4 border-t border-dark-600 bg-dark-700">
        <div class="flex items-start gap-3 rounded-xl bg-dark-600 p-3 shadow-lg border border-dark-500 focus-within:border-primary-500 transition">
          <div class="flex-1">
            <textarea id="userInput" rows="1" class="w-full bg-dark-700 text-gray-100 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-primary-500 resize-none text-base" placeholder="Type your math, code, or logic problem..."></textarea>
          </div>
          <div class="flex flex-col gap-2 mt-1">
            <button id="sendBtn" class="bg-primary-500 hover:bg-primary-600 text-white p-3 rounded-lg transition">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"></path>
              </svg>
            </button>
            <label for="fileInput" class="bg-dark-500 hover:bg-dark-400 text-gray-300 p-2 rounded-lg cursor-pointer transition">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path>
              </svg>
            </label>
            <button id="webSearchBtn" class="bg-dark-500 hover:bg-dark-400 text-gray-300 p-2 rounded-lg transition" title="Toggle Tavily Web Search">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
              </svg>
            </button>
          </div>
        </div>
        <input type="file" id="fileInput" class="hidden" multiple>
        <div id="attachedFiles" class="mt-3 flex flex-wrap gap-3 hidden"></div>
      </div>
    </div>
  </div>

  <!-- Status Notification -->
  <div id="statusNotification" class="fixed bottom-4 right-4 bg-dark-600 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 z-50"></div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 hidden">
    <div class="bg-dark-700 rounded-xl shadow-2xl max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="p-5 border-b border-dark-600 flex justify-between items-center">
        <h2 class="text-xl font-semibold">Enhanced Chain of Draft Settings</h2>
        <button id="closeModalX" class="text-gray-400 hover:text-white">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <div class="p-5">
        <!-- Tab Navigation -->
        <div class="bg-dark-600 rounded-lg p-1 flex mb-5">
          <button class="tab-btn flex-1 py-2 px-4 rounded-md text-white bg-primary-500" data-tab="reasoningTab">CoD Config</button>
          <button class="tab-btn flex-1 py-2 px-4 rounded-md text-gray-400 transition" data-tab="parametersTab">Parameters</button>
          <button class="tab-btn flex-1 py-2 px-4 rounded-md text-gray-400 transition" data-tab="toolsTab">Tools</button>
        </div>
        
        <!-- Enhanced Reasoning Tab Content -->
        <div id="reasoningTab" class="tab-content">
          <h3 class="text-lg font-medium mb-4 pb-2 border-b border-dark-600">Enhanced Chain of Draft Configuration</h3>
          
          <!-- Problem Detection Settings -->
          <div class="bg-gradient-to-r from-blue-900/20 to-purple-900/20 border border-blue-700/30 rounded-lg p-4 mb-5">
            <h4 class="text-sm font-medium text-blue-300 mb-3 flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
              </svg>
              Intelligent Problem Detection
            </h4>
            <div class="space-y-3">
              <div class="flex items-start">
                <input type="checkbox" id="enableProblemDetection" checked class="w-4 h-4 mt-1 text-primary-500 bg-dark-500 border-dark-400 focus:ring-primary-500 focus:ring-offset-dark-700">
                <label for="enableProblemDetection" class="ml-3 block text-sm text-white">
                  Auto-detect complex problems (math, code, logic)
                  <div class="text-gray-400 text-xs mt-1">Automatically triggers enhanced CoD reasoning for challenging problems</div>
                </label>
              </div>
            </div>
          </div>
          
          <!-- CoD Words Per Step Slider -->
          <div class="mb-5">
            <div class="flex justify-between items-center mb-2">
              <label for="codWordsPerStep" class="block text-sm font-medium text-gray-300">CoD Words Per Step</label>
              <span id="codWordsPerStepValue" class="text-sm text-primary-400 font-semibold">5</span>
            </div>
            <input type="range" id="codWordsPerStep" min="5" max="15" step="1" value="5" class="w-full h-2 rounded-lg appearance-none cursor-pointer">
            <div class="flex justify-between text-xs text-gray-500 mt-1">
              <span>5 words (Paper default)</span>
              <span>15 words (More detailed)</span>
            </div>
            <p class="text-xs text-gray-500 mt-2">Based on the Chain of Draft paper: limits each reasoning step to this many words maximum</p>
          </div>
          
          <!-- Enhanced Reasoning Structure -->
          <div class="bg-dark-600 border border-dark-500 rounded-lg p-4 mb-5">
            <h4 class="text-sm font-medium text-gray-300 mb-3">Enhanced Reasoning Structure</h4>
            <div class="space-y-3">
              <div class="flex items-start">
                <input type="checkbox" id="enableDetailedAnalysis" checked class="w-4 h-4 mt-1 text-primary-500 bg-dark-500 border-dark-400 focus:ring-primary-500 focus:ring-offset-dark-700">
                <label for="enableDetailedAnalysis" class="ml-3 block text-sm text-white">
                  Detailed Problem Analysis Phase
                  <div class="text-gray-400 text-xs mt-1">Analyze problem type and break into parts before CoD reasoning</div>
                </label>
              </div>
              <div class="flex items-start">
                <input type="checkbox" id="enablePartReflections" checked class="w-4 h-4 mt-1 text-primary-500 bg-dark-500 border-dark-400 focus:ring-primary-500 focus:ring-offset-dark-700">
                <label for="enablePartReflections" class="ml-3 block text-sm text-white">
                  Detailed Reflections After Each Part
                  <div class="text-gray-400 text-xs mt-1">Create comprehensive reflections after completing each problem part</div>
                </label>
              </div>
              <div class="flex items-start">
                <input type="checkbox" id="enableMetaReflection" checked class="w-4 h-4 mt-1 text-primary-500 bg-dark-500 border-dark-400 focus:ring-primary-500 focus:ring-offset-dark-700">
                <label for="enableMetaReflection" class="ml-3 block text-sm text-white">
                  Meta-Reflection on All Reflections
                  <div class="text-gray-400 text-xs mt-1">Analyze all part reflections to spot insights, mistakes, and improvements</div>
                </label>
              </div>
            </div>
          </div>
          
          <!-- Reasoning Flow Visualization -->
          <div class="bg-dark-700 rounded-lg p-4 mt-6">
            <div class="flex items-center text-blue-300 text-sm font-medium mb-3">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              Enhanced CoD Reasoning Flow
            </div>
            <div class="text-gray-400 text-xs space-y-2">
              <div class="flex items-center space-x-2">
                <div class="w-6 h-6 bg-amber-600 rounded-full flex items-center justify-center text-xs font-bold">1</div>
                <span><strong>Problem Analysis:</strong> Detailed analysis and breakdown into parts (not using CoD)</span>
              </div>
              <div class="flex items-center space-x-2">
                <div class="w-6 h-6 bg-blue-600 rounded-full flex items-center justify-center text-xs font-bold">2</div>
                <span><strong>CoD Reasoning:</strong> Apply Chain of Draft to each part (5-15 words per step)</span>
              </div>
              <div class="flex items-center space-x-2">
                <div class="w-6 h-6 bg-purple-600 rounded-full flex items-center justify-center text-xs font-bold">3</div>
                <span><strong>Part Reflections:</strong> Detailed reflection after each part completion</span>
              </div>
              <div class="flex items-center space-x-2">
                <div class="w-6 h-6 bg-indigo-600 rounded-full flex items-center justify-center text-xs font-bold">4</div>
                <span><strong>Meta-Reflection:</strong> Analyze all reflections for insights and improvements</span>
              </div>
              <div class="flex items-center space-x-2">
                <div class="w-6 h-6 bg-green-600 rounded-full flex items-center justify-center text-xs font-bold">5</div>
                <span><strong>Final Answer:</strong> Comprehensive answer with detailed explanations</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Parameters Tab Content -->
        <div id="parametersTab" class="tab-content hidden">
          <h3 class="text-lg font-medium mb-4 pb-2 border-b border-dark-600">Generation Parameters</h3>
          
          <div class="flex items-center justify-between mb-5 bg-dark-600 rounded-lg p-3 border border-dark-500">
            <label for="streamingToggle" class="flex items-center cursor-pointer">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-primary-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
              </svg>
              <div>
                <div class="font-medium text-sm">Enable Streaming Responses</div>
                <div class="text-gray-400 text-xs mt-0.5">See enhanced CoD reasoning appear in real-time</div>
              </div>
            </label>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" id="streamingToggle" class="sr-only peer" checked>
              <div class="w-11 h-6 bg-dark-500 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-600"></div>
            </label>
          </div>
          
          <div class="mb-4">
            <div class="flex justify-between items-center mb-2">
              <label for="temp" class="block text-sm font-medium text-gray-300">Temperature</label>
              <span id="tempValue" class="text-sm text-gray-400">0.6</span>
            </div>
            <input type="range" id="temp" min="0" max="2" step="0.01" value="0.6" class="w-full h-2 rounded-lg appearance-none cursor-pointer">
            <p class="text-xs text-gray-500 mt-1">Controls randomness: lower values make responses more focused.</p>
          </div>
          
          <div class="mb-4">
            <div class="flex justify-between items-center mb-2">
              <label for="topP" class="block text-sm font-medium text-gray-300">Top P</label>
              <span id="topPValue" class="text-sm text-gray-400">1</span>
            </div>
            <input type="range" id="topP" min="0" max="1" step="0.01" value="1" class="w-full h-2 rounded-lg appearance-none cursor-pointer">
            <p class="text-xs text-gray-500 mt-1">Controls diversity via nucleus sampling.</p>
          </div>

          <div class="mb-4">
            <div class="flex justify-between items-center mb-2">
              <label for="topK" class="block text-sm font-medium text-gray-300">Top K</label>
              <span id="topKValue" class="text-sm text-gray-400">40</span>
            </div>
            <input type="range" id="topK" min="0" max="100" step="1" value="40" class="w-full h-2 rounded-lg appearance-none cursor-pointer">
            <p class="text-xs text-gray-500 mt-1">Restricts selection to the K most likely tokens.</p>
          </div>
          
          <div class="mb-4">
            <div class="flex justify-between items-center mb-2">
              <label for="maxTokens" class="block text-sm font-medium text-gray-300">Max Tokens</label>
              <span id="maxTokensValue" class="text-sm text-gray-400">12000</span>
            </div>
            <input type="range" id="maxTokens" min="1" max="30000" step="128" value="12000" class="w-full h-2 rounded-lg appearance-none cursor-pointer">
            <p class="text-xs text-gray-500 mt-1">Maximum length of the response (increased for enhanced reasoning).</p>
          </div>
        </div>
        
        <!-- Tools Tab Content -->
        <div id="toolsTab" class="tab-content hidden">
          <h3 class="text-lg font-medium mb-4 pb-2 border-b border-dark-600">Available MCP Tools</h3>
          
          <div class="space-y-4">
            <div class="bg-dark-600 border border-dark-500 rounded-lg p-4">
              <div class="flex items-start">
                <input type="checkbox" id="tavilySearchTool" name="mcp_tools" value="tavily_search" class="w-4 h-4 mt-1 text-primary-500 bg-dark-500 border-dark-400 focus:ring-primary-500 focus:ring-offset-dark-700">
                <label for="tavilySearchTool" class="ml-3 block text-sm font-medium text-white">
                  Enable Tavily Web Search
                  <div class="text-gray-400 text-xs mt-1">Allows enhanced CoD reasoning with up-to-date web information</div>
                </label>
              </div>
            </div>
          </div>
        </div>
        
        <div class="flex justify-end gap-3 pt-4 mt-4 border-t border-dark-600">
          <button id="closeSettings" class="px-4 py-2 bg-dark-600 hover:bg-dark-500 text-gray-300 rounded-lg transition">
            Cancel
          </button>
          <button id="saveSettings" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg transition">
            Save Settings
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /***********************
     * Global Configuration
     ***********************/
    const FIREWORKS_MODEL = "accounts/fireworks/models/qwen3-235b-a22b";

    // Enhanced CoD Configuration
    let COD_WORDS_PER_STEP = 5; // Configurable from 5-15 words
    let ENABLE_PROBLEM_DETECTION = true;
    let ENABLE_DETAILED_ANALYSIS = true;
    let ENABLE_PART_REFLECTIONS = true;
    let ENABLE_META_REFLECTION = true;
    
    let TEMPERATURE = 0.6;
    let TOP_P = 1;
    let TOP_K = 40;
    let MAX_TOKENS = 12000; // Increased for enhanced reasoning
    let ENABLE_STREAMING = true;
    let ENABLED_MCP_TOOLS = [];
    let enableWebSearchQuickToggle = false;
    
    /***********************
     * Enhanced CoD Prompts
     ***********************/
    function generateEnhancedCoDPrompt() {
      return `You are an advanced AI reasoning system that uses an Enhanced Chain of Draft (CoD) methodology for solving complex problems. When you receive a problem that appears to be mathematical, coding-related, or involves complex logic, follow this structured approach:

## ENHANCED CHAIN OF DRAFT REASONING STRUCTURE

### Phase 1: PROBLEM ANALYSIS (Detailed - NOT using CoD)
${ENABLE_DETAILED_ANALYSIS ? `
**[PROBLEM ANALYSIS]**
First, provide a comprehensive analysis of the problem:
- Identify the problem type (mathematical, coding, logical reasoning, etc.)
- Break down the problem into main components/parts that need to be solved
- Determine the logical sequence for solving each part
- Estimate complexity and potential challenges
- List what information is given and what needs to be found

This analysis should be thorough and detailed - do NOT use the ${COD_WORDS_PER_STEP}-word limit here.
` : ''}

### Phase 2: ENHANCED COD REASONING BY PARTS
For each main part identified in the analysis, apply Chain of Draft reasoning:

**CoD Guidelines:**
- Each reasoning step limited to **${COD_WORDS_PER_STEP} words maximum**
- Focus on essential information only
- Use mathematical notation, equations, and shorthand where possible
- Number each CoD step clearly

**Format for each part:**
\`\`\`
**PART X: [Part Description]**
CoD Step 1: [${COD_WORDS_PER_STEP} words max]
CoD Step 2: [${COD_WORDS_PER_STEP} words max]
CoD Step 3: [${COD_WORDS_PER_STEP} words max]
...continue until part is complete
\`\`\`

### Phase 3: PART REFLECTIONS
${ENABLE_PART_REFLECTIONS ? `
After completing each part, create a detailed reflection:

**[REFLECTION X]**
- Verify calculations and logic used in this part
- Assess confidence level in the solution
- Identify any potential issues or alternative approaches
- Connect this part to the overall problem solution
- Note insights gained that might affect other parts

These reflections should be comprehensive - do NOT use the ${COD_WORDS_PER_STEP}-word limit here.
` : ''}

### Phase 4: META-REFLECTION
${ENABLE_META_REFLECTION ? `
After completing all parts and their individual reflections:

**[META-REFLECTION ON ALL PARTS]**
- Review all individual reflections together
- Look for patterns, insights, or contradictions across parts
- Identify any mistakes or improvements needed
- Verify the overall solution coherence
- Assess the completeness of the solution
- Note any alternative approaches that might be better

This meta-reflection should be thorough and comprehensive.
` : ''}

### Phase 5: FINAL COMPREHENSIVE ANSWER
Provide your final answer with detailed explanations:
- Clearly state the solution
- Explain why this solution is correct
- Reference key insights from your reflections
- Show how all parts connect to form the complete solution

## IMPORTANT NOTES:
- Only apply this enhanced structure to complex problems (math, code, logic)
- For simple questions, use standard responses
- The ${COD_WORDS_PER_STEP}-word limit applies ONLY to CoD steps, not to analysis or reflections
- Use mathematical notation and shorthand in CoD steps to maximize information density
- Be precise and concise in CoD steps, but thorough in reflections

Begin your response now:`;
    }
    
    /***********************
     * Problem Detection
     ***********************/
    function isComplexProblem(userMessage) {
      if (!ENABLE_PROBLEM_DETECTION) return false;
      
      const complexPatterns = [
        // Math indicators
        /\b(solve|calculate|compute|find|determine)\b.*\b(equation|formula|integral|derivative|matrix|polynomial|probability|statistics)\b/i,
        /\b(algebra|calculus|geometry|trigonometry|logarithm|exponential)\b/i,
        /\b(\d+)\s*[\+\-\*\/\^]\s*(\d+)/,
        /\b(proof|theorem|lemma|corollary)\b/i,
        
        // Code indicators
        /\b(code|program|algorithm|function|class|debug|optimize|implement)\b/i,
        /\b(python|javascript|java|c\+\+|sql|html|css|react|node)\b/i,
        /\b(loop|recursion|sorting|search|data structure|complexity)\b/i,
        /```[\s\S]*```/,
        
        // Logic indicators
        /\b(logic|reasoning|proof|contradict|syllogism|premise|conclusion)\b/i,
        /\b(if.*then|implies|necessary|sufficient|proof by)\b/i,
        /\b(true|false|and|or|not)\b.*\b(statement|proposition)\b/i,
        
        // Complex problem indicators
        /\b(step by step|break down|analyze|systematic|complex|challenging)\b/i,
        /\b(multiple|several|various|different)\b.*\b(parts|components|aspects|steps)\b/i
      ];
      
      return complexPatterns.some(pattern => pattern.test(userMessage));
    }
    
    /***********************
     * Thread Management
     ***********************/
    let threads = [];
    let currentThreadId = null;
    let threadCounter = 1;
    
    function createNewThread() {
      const newThread = {
        id: Date.now(),
        name: `Thread ${threadCounter++}`,
        messages: []
      };
      threads.push(newThread);
      currentThreadId = newThread.id;
      updateThreadList();
      renderCurrentThreadMessages();
      showNotification("New thread created");
    }
    
    function updateThreadList() {
      const threadList = document.getElementById("threadList");
      if (threadList) {
        threadList.innerHTML = "";
        threads.forEach(thread => {
          const li = document.createElement("li");
          li.textContent = thread.name;
          li.className = "px-3 py-2 rounded-md cursor-pointer hover:bg-dark-500 transition";
          if (thread.id === currentThreadId) {
            li.classList.add("bg-dark-600", "text-primary-300");
          } else {
            li.classList.add("text-gray-300");
          }
          li.addEventListener("click", () => {
            currentThreadId = thread.id;
            renderCurrentThreadMessages();
            updateThreadList();
          });
          threadList.appendChild(li);
        });
      }
      
      const mobileThreadList = document.getElementById("mobileThreadList");
      if (mobileThreadList) {
        mobileThreadList.innerHTML = "";
        threads.forEach(thread => {
          const li = document.createElement("li");
          li.textContent = thread.name;
          li.className = "px-3 py-2 rounded-md cursor-pointer hover:bg-dark-500 transition";
          if (thread.id === currentThreadId) {
            li.classList.add("bg-dark-600", "text-primary-300");
          } else {
            li.classList.add("text-gray-300");
          }
          li.addEventListener("click", () => {
            currentThreadId = thread.id;
            renderCurrentThreadMessages();
            updateThreadList();
            document.getElementById("mobileSidebar").classList.remove("translate-x-0");
            document.getElementById("mobileSidebar").classList.add("-translate-x-full");
          });
          mobileThreadList.appendChild(li);
        });
      }
    }
    
    function deleteCurrentThread() {
      if (!currentThreadId) return;
      if (confirm("Are you sure you want to delete this thread?")) {
        threads = threads.filter(thread => thread.id !== currentThreadId);
        if (threads.length > 0) {
          currentThreadId = threads[0].id;
        } else {
          createNewThread(); 
          return;
        }
        updateThreadList();
        renderCurrentThreadMessages();
        showNotification("Thread deleted");
      }
    }
    
    function downloadCurrentThreadAsTxt() {
      const thread = threads.find(t => t.id === currentThreadId);
      if (!thread) { 
        showNotification("Error: No active thread found"); 
        return; 
      }
      
      let content = `Enhanced AI Reasoning Studio - Chain of Draft\nCoD Words Per Step: ${COD_WORDS_PER_STEP}\nModel: ${FIREWORKS_MODEL}\n\n`;
      
      thread.messages.forEach(msg => {
        if (msg.isPlaceholder) return;
        const prefix = msg.sender.toUpperCase();
        content += `${prefix}:\n${msg.content}\n\n`;
        
        if (msg.sender === 'bot' && !msg.isPlaceholder && !msg.isStreaming) {
          if (msg.wordCount !== undefined) {
            content += `(Words: ${msg.wordCount})`;
          }
          if (msg.totalTokens !== undefined) {
            content += ` (Tokens: ${msg.totalTokens})`;
          }
          if (msg.durationSeconds !== undefined) {
            content += ` (Time: ${msg.durationSeconds}s)`;
          }
          content += "\n\n";
        }
      });
      
      const blob = new Blob([content], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `${thread.name || "Thread"}_Enhanced_CoD.txt`;
      a.style.display = 'none';
      document.body.appendChild(a);
      a.click();
      setTimeout(() => { 
        document.body.removeChild(a); 
        URL.revokeObjectURL(url); 
      }, 100);
      showNotification("Enhanced CoD file downloaded");
    }
    
    function showNotification(message, duration = 3000) {
      const notification = document.getElementById("statusNotification");
      notification.textContent = message;
      notification.classList.add("opacity-100");
      setTimeout(() => { 
        notification.classList.remove("opacity-100"); 
      }, duration);
    }
    
    let attachedFiles = [];
    
    function handleFileInput() {
      const fileInput = document.getElementById('fileInput');
      const attachedFilesContainer = document.getElementById('attachedFiles');
      if (!fileInput || !attachedFilesContainer) return;
      
      fileInput.addEventListener('change', (event) => {
        try {
          const files = event.target.files;
          const maxFileSize = 10 * 1024 * 1024;
          
          if (files.length > 0) {
            attachedFilesContainer.classList.remove('hidden');
            for (let i = 0; i < files.length; i++) {
              const file = files[i];
              if (file.size > maxFileSize) { 
                showNotification(`File ${file.name} is too large (max 10MB)`); 
                continue; 
              }
              if (attachedFiles.some(f => f.name === file.name && f.size === file.size)) { 
                showNotification(`File ${file.name} already attached`); 
                continue; 
              }
              attachedFiles.push(file);
              createFilePreview(file, attachedFilesContainer);
            }
            fileInput.value = '';
          }
        } catch (error) { 
          console.error('Error handling file upload:', error); 
          showNotification('Error uploading file.'); 
        }
      });
    }
    
    function createFilePreview(file, container) {
      const filePreview = document.createElement('div');
      filePreview.className = 'relative bg-dark-700 rounded-lg p-2 border border-dark-600';
      
      if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = document.createElement('img'); 
          img.className = 'w-16 h-16 object-cover rounded'; 
          img.src = e.target.result; 
          filePreview.appendChild(img);
          
          const fileName = document.createElement('div'); 
          fileName.className = 'mt-1 text-xs text-gray-400 text-center truncate w-16'; 
          fileName.textContent = file.name.length > 15 ? file.name.substring(0, 12) + '...' : file.name; 
          filePreview.appendChild(fileName);
        }; 
        reader.readAsDataURL(file);
      } else {
        const icon = document.createElement('div'); 
        icon.className = 'w-16 h-16 flex items-center justify-center bg-dark-600 rounded text-2xl'; 
        icon.textContent = getFileIcon(file.type); 
        filePreview.appendChild(icon);
        
        const fileName = document.createElement('div'); 
        fileName.className = 'mt-1 text-xs text-gray-400 text-center truncate w-16'; 
        fileName.textContent = file.name.length > 15 ? file.name.substring(0, 12) + '...' : file.name; 
        filePreview.appendChild(fileName);
      }
      
      const removeButton = document.createElement('button'); 
      removeButton.className = 'absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs'; 
      removeButton.textContent = '×';
      removeButton.addEventListener('click', () => { 
        attachedFiles = attachedFiles.filter(f => f !== file); 
        filePreview.remove(); 
        if (attachedFiles.length === 0) container.classList.add('hidden'); 
      });
      
      filePreview.appendChild(removeButton); 
      container.appendChild(filePreview);
    }
    
    function getFileIcon(fileType) {
      if (fileType.startsWith('image/')) return '🖼️'; 
      if (fileType.startsWith('text/')) return '📄'; 
      if (fileType.includes('pdf')) return '📑'; 
      if (fileType.includes('word') || fileType.includes('document')) return '📝'; 
      if (fileType.includes('excel') || fileType.includes('spreadsheet')) return '📊'; 
      if (fileType.includes('audio')) return '🎵'; 
      if (fileType.includes('video')) return '🎬'; 
      return '📦';
    }
    
    function countWords(text) {
      if (!text) return 0;
      const textWithoutCode = text.replace(/```[\s\S]*?```/g, '');
      let processedText = textWithoutCode.replace(/\b\w+\s*=\s*[\d\w+\-*/()]+/g, "EQUATION").replace(/\b\d+\/\d+\b/g, "FRACTION").replace(/[+\-*/=<>]+/g, " ");
      return processedText.split(/\s+/).filter(word => word.length > 0).length;
    }
    
    function parseEnhancedCoDResponse(content) {
      const sections = {
        problemAnalysis: '',
        parts: [],
        reflections: [],
        metaReflection: '',
        finalAnswer: ''
      };
      
      // Extract Problem Analysis
      const analysisMatch = content.match(/\*\*\[PROBLEM ANALYSIS\]\*\*([\s\S]*?)(?=\*\*PART|$)/i);
      if (analysisMatch) {
        sections.problemAnalysis = analysisMatch[1].trim();
      }
      
      // Extract Parts and CoD steps
      const partMatches = content.matchAll(/\*\*PART (\d+): ([^*]+)\*\*([\s\S]*?)(?=\*\*(?:PART|\[REFLECTION|\[META-REFLECTION|$))/gi);
      for (const match of partMatches) {
        const partNumber = match[1];
        const partTitle = match[2].trim();
        const partContent = match[3].trim();
        sections.parts.push({
          number: partNumber,
          title: partTitle,
          content: partContent
        });
      }
      
      // Extract Reflections
      const reflectionMatches = content.matchAll(/\*\*\[REFLECTION (\d+)\]\*\*([\s\S]*?)(?=\*\*(?:\[REFLECTION|\[META-REFLECTION|PART|$))/gi);
      for (const match of reflectionMatches) {
        const reflectionNumber = match[1];
        const reflectionContent = match[2].trim();
        sections.reflections.push({
          number: reflectionNumber,
          content: reflectionContent
        });
      }
      
      // Extract Meta-Reflection
      const metaReflectionMatch = content.match(/\*\*\[META-REFLECTION ON ALL PARTS\]\*\*([\s\S]*?)(?=\*\*|###|$)/i);
      if (metaReflectionMatch) {
        sections.metaReflection = metaReflectionMatch[1].trim();
      }
      
      // Extract Final Answer (everything after the last reflection or meta-reflection)
      const finalAnswerMatch = content.match(/(?:META-REFLECTION.*?[\s\S]*?)(?:###.*?|$)([\s\S]*)$/i);
      if (finalAnswerMatch) {
        sections.finalAnswer = finalAnswerMatch[1].trim();
      } else {
        // Fallback: take content after last reflection
        const lastReflectionIndex = Math.max(
          content.lastIndexOf('**[REFLECTION'),
          content.lastIndexOf('**[META-REFLECTION')
        );
        if (lastReflectionIndex !== -1) {
          const afterLastReflection = content.substring(lastReflectionIndex);
          const endOfReflection = afterLastReflection.search(/\n\n(?!\s*-)/);
          if (endOfReflection !== -1) {
            sections.finalAnswer = afterLastReflection.substring(endOfReflection).trim();
          }
        }
      }
      
      return sections;
    }
    
    function formatEnhancedCoDSteps(partContent) {
      const lines = partContent.split('\n').filter(line => line.trim());
      let html = '';
      let stepCounter = 1;
      
      for (const line of lines) {
        const trimmed = line.trim();
        if (trimmed.match(/^CoD Step \d+:/i)) {
          const stepContent = trimmed.replace(/^CoD Step \d+:\s*/i, '');
          html += `
            <div class="flex items-start p-2 mb-2 rounded-lg bg-blue-900/20 border-l-2 border-blue-500 cod-step">
              <span class="flex items-center justify-center min-w-6 h-6 mr-3 rounded-full bg-blue-700 text-blue-200 text-xs font-bold">${stepCounter++}</span>
              <span class="step-content font-mono text-sm text-blue-100">${stepContent}</span>
            </div>
          `;
        } else if (trimmed) {
          html += `<div class="text-sm text-gray-300 mb-1">${trimmed}</div>`;
        }
      }
      
      return html;
    }
    
    function transformMessage(content) {
      if (!content) return '';
      
      if (typeof marked !== 'undefined') {
        try {
          return marked.parse(content);
        } catch (e) {
          console.warn('Marked.js error:', e);
          return content.replace(/\n/g, '<br>');
        }
      } else {
        return content.replace(/```([\s\S]*?)```/g, (match, codeContent) => {
          let language = ''; 
          const lines = codeContent.split('\n');
          if (lines.length > 0 && !lines[0].includes(' ')) { 
            language = lines[0].trim(); 
            lines.shift(); 
          }
          return `<pre><code class="${language}">${lines.join('\n')}</code></pre>`;
        }).replace(/\n/g, '<br>');
      }
    }
    
    function renderCurrentThreadMessages() {
      const chatMessagesDiv = document.getElementById("chatMessages");
      if (!chatMessagesDiv) return;
      
      chatMessagesDiv.innerHTML = "";
      const thread = threads.find(t => t.id === currentThreadId);
      
      if (thread) {
        thread.messages.forEach(msg => {
          const messageDiv = document.createElement("div");
          
          if (msg.sender === "user") {
            messageDiv.className = "flex justify-end";
            const msgContent = document.createElement("div");
            msgContent.className = "max-w-[90%] bg-primary-600 text-white p-4 rounded-2xl rounded-tr-sm shadow-md";
            msgContent.innerHTML = transformMessage(msg.content);
            if (msg.files && msg.files.length > 0) addFilesToMessage(msgContent, msg.files);
            messageDiv.appendChild(msgContent);
          } else { // Bot message
            messageDiv.className = "flex justify-start";
            const msgContent = document.createElement("div");
            msgContent.className = "max-w-[95%] bg-dark-700 border border-dark-500 p-4 rounded-2xl rounded-tl-sm shadow-md";
            
            if (msg.isPlaceholder) {
              msgContent.classList.add("opacity-70");
              msgContent.innerHTML = `<div class="flex items-center gap-2"><svg class="animate-spin h-4 w-4 text-primary-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>${msg.content}</div>`;
            } else if (msg.isStreaming) {
              msgContent.classList.add("streaming");
              msgContent.innerHTML = transformMessage(msg.content); 
              msgContent.innerHTML += `<div class="text-primary-400 text-xs mt-2 streaming-indicator">Generating Enhanced CoD Reasoning</div>`;
            } else if (msg.enhancedCoD) { 
              // Render Enhanced CoD Structure
              const sections = parseEnhancedCoDResponse(msg.content);
              
              // Problem Analysis
              if (sections.problemAnalysis && ENABLE_DETAILED_ANALYSIS) {
                const analysisContainer = document.createElement("div");
                analysisContainer.className = "problem-analysis bg-amber-900/20 rounded-lg p-4 mb-4 border border-amber-700/30";
                
                const analysisLabel = document.createElement("div");
                analysisLabel.className = "text-xs uppercase tracking-wider font-semibold text-amber-400 mb-3 pb-2 border-b border-amber-600/30 flex items-center";
                analysisLabel.innerHTML = `
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                  </svg>
                  Problem Analysis & Breakdown
                `;
                analysisContainer.appendChild(analysisLabel);
                
                const analysisContent = document.createElement("div");
                analysisContent.innerHTML = transformMessage(sections.problemAnalysis); 
                analysisContainer.appendChild(analysisContent);
                msgContent.appendChild(analysisContainer);
              }
              
              // CoD Parts
              sections.parts.forEach((part, index) => {
                const partContainer = document.createElement("div");
                partContainer.className = "bg-blue-900/20 rounded-lg p-4 mb-4 border border-blue-700/30";
                
                const partLabel = document.createElement("div");
                partLabel.className = "text-xs uppercase tracking-wider font-semibold text-blue-400 mb-3 pb-2 border-b border-blue-600/30 flex items-center justify-between";
                partLabel.innerHTML = `
                  <div class="flex items-center">
                    <div class="w-6 h-6 bg-blue-600 rounded-full flex items-center justify-center text-xs font-bold mr-2">${part.number}</div>
                    Chain of Draft - Part ${part.number}: ${part.title}
                  </div>
                  <div class="text-xs text-blue-300">${COD_WORDS_PER_STEP} words/step max</div>
                `;
                partContainer.appendChild(partLabel);
                
                const partContent = document.createElement("div");
                partContent.innerHTML = formatEnhancedCoDSteps(part.content);
                partContainer.appendChild(partContent);
                msgContent.appendChild(partContainer);
                
                // Add reflection for this part
                if (sections.reflections[index] && ENABLE_PART_REFLECTIONS) {
                  const reflectionContainer = document.createElement("div");
                  reflectionContainer.className = "reflection-box bg-purple-900/20 rounded-lg p-4 mb-4 border border-purple-700/30";
                  
                  const reflectionLabel = document.createElement("div");
                  reflectionLabel.className = "text-xs uppercase tracking-wider font-semibold text-purple-400 mb-3 pb-2 border-b border-purple-600/30 flex items-center";
                  reflectionLabel.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                    </svg>
                    Detailed Reflection ${sections.reflections[index].number}
                  `;
                  reflectionContainer.appendChild(reflectionLabel);
                  
                  const reflectionContent = document.createElement("div");
                  reflectionContent.innerHTML = transformMessage(sections.reflections[index].content);
                  reflectionContainer.appendChild(reflectionContent);
                  msgContent.appendChild(reflectionContainer);
                }
              });
              
              // Meta-Reflection
              if (sections.metaReflection && ENABLE_META_REFLECTION) {
                const metaContainer = document.createElement("div");
                metaContainer.className = "meta-reflection rounded-lg p-4 mb-4 border border-indigo-700/30";
                
                const metaLabel = document.createElement("div");
                metaLabel.className = "text-xs uppercase tracking-wider font-semibold text-indigo-400 mb-3 pb-2 border-b border-indigo-600/30 flex items-center";
                metaLabel.innerHTML = `
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                  </svg>
                  Meta-Reflection on All Parts
                `;
                metaContainer.appendChild(metaLabel);
                
                const metaContent = document.createElement("div");
                metaContent.innerHTML = transformMessage(sections.metaReflection);
                metaContainer.appendChild(metaContent);
                msgContent.appendChild(metaContainer);
              }
              
              // Final Answer
              if (sections.finalAnswer) {
                const answerContainer = document.createElement("div");
                answerContainer.className = "final-answer rounded-lg p-4 border border-green-700/30";
                
                const answerLabel = document.createElement("div");
                answerLabel.className = "text-xs uppercase tracking-wider font-semibold text-green-400 mb-3 pb-2 border-b border-green-600/30 flex items-center";
                answerLabel.innerHTML = `
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  Final Comprehensive Answer
                `;
                answerContainer.appendChild(answerLabel);
                
                const answerContent = document.createElement("div");
                answerContent.innerHTML = transformMessage(sections.finalAnswer); 
                answerContainer.appendChild(answerContent);
                msgContent.appendChild(answerContainer);
              }
            } else { 
              msgContent.innerHTML = transformMessage(msg.content);
            }
            
            if (msg.tool_calls && msg.tool_calls.length > 0) {
              const toolBadge = document.createElement("div");
              toolBadge.className = "mt-2 px-2 py-1 bg-blue-900/20 border border-blue-800/30 rounded text-xs text-blue-400";
              let toolCallSummary = msg.tool_calls.map(tc => tc.type === "function" && tc.function ? `${tc.function.name}(${tc.function.arguments ? Object.values(JSON.parse(tc.function.arguments)).join(', ') : ''})` : tc.type).join(", ");
              toolBadge.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" /></svg> Requested: ${toolCallSummary}`;
              msgContent.appendChild(toolBadge);
            }

            if (!msg.isPlaceholder && !msg.isStreaming) {
              const statsDiv = document.createElement("div");
              statsDiv.className = "mt-3 pt-2 border-t border-dark-600/50 text-xs text-gray-400 flex flex-wrap gap-x-4 gap-y-1 items-center";
              
              let statsAdded = false;
              if (msg.wordCount !== undefined) {
                const wordStat = document.createElement('span');
                wordStat.innerHTML = `Words: <span class="text-gray-300">${msg.wordCount}</span>`;
                statsDiv.appendChild(wordStat);
                statsAdded = true;
              }

              if (msg.totalTokens !== undefined) {
                const tokenStat = document.createElement('span');
                tokenStat.innerHTML = `Tokens: <span class="text-teal-300 font-medium">${msg.totalTokens}</span>`;
                if (msg.promptTokens !== undefined && msg.completionTokens !== undefined) {
                  tokenStat.innerHTML = `Tokens: <span class="text-gray-300">${msg.promptTokens}</span> (p) + <span class="text-teal-300 font-medium">${msg.completionTokens}</span> (c)`;
                }
                statsDiv.appendChild(tokenStat);
                statsAdded = true;
              }

              if (msg.durationSeconds !== undefined) {
                const timeStat = document.createElement('span');
                timeStat.innerHTML = `Time: <span class="text-amber-400 font-medium">${msg.durationSeconds}s</span>`;
                statsDiv.appendChild(timeStat);
                statsAdded = true;
              }

              if (msg.enhancedCoD) {
                const codStat = document.createElement('span');
                codStat.innerHTML = `CoD: <span class="text-primary-400 font-medium">${COD_WORDS_PER_STEP} words/step</span>`;
                statsDiv.appendChild(codStat);
                statsAdded = true;
              }

              if (statsAdded) {
                msgContent.appendChild(statsDiv);
              }
            }
            messageDiv.appendChild(msgContent);
          }
          chatMessagesDiv.appendChild(messageDiv);
        });
        chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
      }
      
      if (typeof hljs !== 'undefined') { 
        document.querySelectorAll('pre code').forEach((block) => hljs.highlightElement(block)); 
      }
      addCodeCopyButtons();
    }
    
    function addFilesToMessage(msgContent, files) {
      const filesDiv = document.createElement('div'); 
      filesDiv.className = 'mt-2 text-xs text-gray-300 italic';
      filesDiv.textContent = `(${files.length} file(s) attached, not sent to this model)`; 
      msgContent.appendChild(filesDiv);
    }
    
    function addMessageToCurrentThread(content, sender, isPlaceholder = false, files = []) {
      const thread = threads.find(t => t.id === currentThreadId);
      if (thread) {
        const wordCount = sender === "bot" && !isPlaceholder ? countWords(content) : 0;
        const isComplex = sender === "user" ? isComplexProblem(content) : false;
        
        thread.messages.push({
          content, 
          sender, 
          isPlaceholder, 
          timestamp: new Date(),
          wordCount: wordCount,
          files: files && files.length > 0 ? files.map(f => ({ name: f.name, type: f.type, size: f.size })) : undefined,
          enhancedCoD: sender === "bot" && !isPlaceholder && isComplex,
          isComplexProblem: isComplex
        });
        renderCurrentThreadMessages();
      }
    }
    
    function buildMessagesForChat() {
      const thread = threads.find(t => t.id === currentThreadId);
      if (!thread) return [];
      
      const messages = [];
      
      // Check if the last user message is a complex problem
      const lastUserMessage = thread.messages.filter(msg => msg.sender === "user" && !msg.isPlaceholder).pop();
      const useEnhancedCoD = lastUserMessage && isComplexProblem(lastUserMessage.content);
      
      if (useEnhancedCoD) {
        messages.push({ role: "system", content: generateEnhancedCoDPrompt() });
      }
      
      thread.messages.filter(msg => !msg.isPlaceholder).forEach(msg => {
        const apiMessage = { 
          role: msg.sender === "user" ? "user" : "assistant", 
          content: msg.content 
        };
        if (msg.tool_calls) apiMessage.tool_calls = msg.tool_calls;
        messages.push(apiMessage);
      });
      
      return messages;
    }
    
    function getToolsConfiguration() {
      const tools = [];
      if (ENABLED_MCP_TOOLS.includes("tavily_search") || enableWebSearchQuickToggle) {
        tools.push({ 
          type: "function", 
          function: { 
            name: "tavily_search", 
            description: "Performs a web search using Tavily for up-to-date information to enhance CoD reasoning.", 
            parameters: { 
              type: "object", 
              properties: { 
                query: { 
                  type: "string", 
                  description: "The search query for Tavily." 
                }
              }, 
              required: ["query"]
            }
          }
        });
      }
      return tools.length > 0 ? tools : undefined;
    }
    
    async function sendMessage(message) {
      ENABLE_STREAMING = (localStorage.getItem('streamingEnabled') !== null) ? (localStorage.getItem('streamingEnabled') === 'true') : ENABLE_STREAMING;
      
      const isComplex = isComplexProblem(message);
      addMessageToCurrentThread(message, "user", false, attachedFiles.map(f => ({name: f.name, type: f.type, size: f.size})));
      attachedFiles = []; 
      const attachedFilesContainer = document.getElementById('attachedFiles');
      if (attachedFilesContainer) { 
        attachedFilesContainer.innerHTML = ''; 
        attachedFilesContainer.classList.add('hidden'); 
      }
      
      let placeholderText = isComplex ? "Analyzing problem and preparing Enhanced Chain of Draft reasoning..." : "Thinking...";
      addMessageToCurrentThread(placeholderText, "bot", true);
      const thread = threads.find(t => t.id === currentThreadId);
      const placeholderIndex = thread.messages.length - 1;
      
      const startTime = performance.now(); 
      let usageData = null; 
    
      try {
        const messagesForApi = buildMessagesForChat();
        const tools = getToolsConfiguration();
        let validatedMaxTokens = parseInt(MAX_TOKENS);
        if (isNaN(validatedMaxTokens) || !isFinite(validatedMaxTokens)) validatedMaxTokens = 12000;
        validatedMaxTokens = Math.min(Math.max(1, validatedMaxTokens), 30000);
        
        const payload = { 
          model: FIREWORKS_MODEL, 
          messages: messagesForApi, 
          temperature: TEMPERATURE, 
          top_p: TOP_P, 
          top_k: TOP_K, 
          max_tokens: validatedMaxTokens, 
          stream: ENABLE_STREAMING 
        };
        
        if (tools && tools.length > 0) { 
          payload.tools = tools; 
          payload.tool_choice = "auto"; 
        }
        
        if (ENABLE_STREAMING) {
          console.log("Using Enhanced CoD streaming mode. Complex problem detected:", isComplex);
          thread.messages[placeholderIndex].content = "Connecting to Enhanced CoD API..."; 
          renderCurrentThreadMessages();
          
          let fullResponse = ""; 
          let currentToolCalls = []; 
          let renderPending = false;
          
          const response = await fetch('/api/chat', { 
            method: "POST", 
            headers: { 
                "Accept": "text/event-stream", 
                "Content-Type": "application/json"
            }, 
            body: JSON.stringify(payload)
          });
    
          if (!response.ok) { 
            const errorText = await response.text(); 
            console.error("Enhanced CoD Streaming API Error Status:", response.status);
            console.error("Enhanced CoD Streaming API Error Text:", errorText); 
            let errorData; 
            try { 
              errorData = JSON.parse(errorText); 
            } catch (e) { 
              errorData = { message: response.statusText || "Unknown streaming error" }; 
            } 
            throw new Error(`Error starting Enhanced CoD stream: ${response.status} - ${errorData.fault?.faultstring || errorData.message || 'Unknown error'}`); 
          }
          
          const reader = response.body.getReader(); 
          const decoder = new TextDecoder();
          
          while (true) {
            const { done, value } = await reader.read(); 
            if (done) { 
              console.log("Enhanced CoD Stream complete"); 
              break; 
            }
            
            const chunk = decoder.decode(value, { stream: true }); 
            const lines = chunk.split('\n');
            
            for (const line of lines) {
              if (line.startsWith('data: ')) {
                const dataText = line.substring(6).trim(); 
                if (dataText === '[DONE]') { 
                  console.log("Received [DONE] marker"); 
                  continue; 
                }
                
                try {
                  const data = JSON.parse(dataText);
                  if (data.usage) {
                    usageData = data.usage; 
                  }
    
                  if (data.choices && data.choices[0]) {
                    const delta = data.choices[0].delta;
                    if (delta && delta.content) fullResponse += delta.content;
                    
                    if (delta && delta.tool_calls) { 
                      delta.tool_calls.forEach(tc => { 
                        if (tc.index >= currentToolCalls.length) {
                          currentToolCalls.push({ 
                            id: tc.id, 
                            type: tc.type, 
                            function: { 
                              name: tc.function.name, 
                              arguments: "" 
                            }
                          }); 
                        }
                        if (tc.function && tc.function.arguments) {
                          currentToolCalls[tc.index].function.arguments += tc.function.arguments; 
                        }
                      }); 
                    }
                    
                    thread.messages[placeholderIndex] = { 
                      ...thread.messages[placeholderIndex],
                      content: fullResponse, 
                      sender: "bot", 
                      isPlaceholder: false, 
                      timestamp: new Date(), 
                      isStreaming: true, 
                      enhancedCoD: isComplex,
                      tool_calls: currentToolCalls.length > 0 ? JSON.parse(JSON.stringify(currentToolCalls)) : undefined 
                    };
                    
                    if (!renderPending) { 
                      renderPending = true; 
                      requestAnimationFrame(() => { 
                        renderCurrentThreadMessages(); 
                        renderPending = false; 
                      }); 
                    }
                    
                    if (data.choices[0].finish_reason) {
                      console.log("Enhanced CoD Stream finished with reason:", data.choices[0].finish_reason);
                      if(data.usage) {
                         usageData = data.usage;
                      }
                    }
                  }
                } catch (parseError) { 
                  if (dataText) {
                    console.log("Non-JSON data or parse error in Enhanced CoD stream:", dataText, parseError); 
                  }
                }
              }
            }
          }
          
          const endTime = performance.now();
          const durationSeconds = ((endTime - startTime) / 1000).toFixed(2);
          
          thread.messages[placeholderIndex] = { 
            content: fullResponse, 
            sender: "bot", 
            isPlaceholder: false, 
            timestamp: new Date(), 
            wordCount: countWords(fullResponse), 
            enhancedCoD: isComplex,
            isStreaming: false, 
            tool_calls: currentToolCalls.length > 0 ? currentToolCalls : undefined,
            durationSeconds: durationSeconds,
            promptTokens: usageData ? usageData.prompt_tokens : undefined,
            completionTokens: usageData ? usageData.completion_tokens : undefined,
            totalTokens: usageData ? usageData.total_tokens : undefined
          };
          renderCurrentThreadMessages();
    
        } else { // Non-streaming
          console.log("Sending Enhanced CoD non-streaming request. Complex problem detected:", isComplex);
          
          const response = await fetch('/api/chat', { 
            method: "POST", 
            headers: { 
                "Accept": "application/json", 
                "Content-Type": "application/json"
            }, 
            body: JSON.stringify(payload)
          });
          
          if (!response.ok) { 
            const errorText = await response.text(); 
            console.error("Enhanced CoD Non-Streaming API Error Status:", response.status);
            console.error("Enhanced CoD Non-Streaming API Error Text:", errorText); 
            let errorData; 
            try { 
              errorData = JSON.parse(errorText); 
            } catch (e) { 
              errorData = { message: response.statusText || "Unknown non-streaming error" };
            } 
            throw new Error(`Enhanced CoD API returned status: ${response.status} - ${errorData.fault?.faultstring || errorData.message || 'Unknown error'}`);
          }
          
          const data = await response.json();
          const endTime = performance.now();
          const durationSeconds = ((endTime - startTime) / 1000).toFixed(2);
          usageData = data.usage; 
    
          const botReply = data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content; 
          const toolCalls = data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.tool_calls;
          
          if (botReply || toolCalls) {
            const finalContent = botReply || ""; 
            
            thread.messages[placeholderIndex] = { 
                content: finalContent, 
                sender: "bot", 
                isPlaceholder: false, 
                timestamp: new Date(), 
                wordCount: countWords(finalContent), 
                enhancedCoD: isComplex,
                tool_calls: toolCalls,
                durationSeconds: durationSeconds,
                promptTokens: usageData ? usageData.prompt_tokens : undefined,
                completionTokens: usageData ? usageData.completion_tokens : undefined,
                totalTokens: usageData ? usageData.total_tokens : undefined
            };
            renderCurrentThreadMessages();
          } else { 
            console.error("Enhanced CoD API Response Data:", data); 
            throw new Error("No content or tool_calls in Enhanced CoD API response."); 
          }
        }
      } catch (error) {
        console.error("Error sending Enhanced CoD message:", error);
        const endTime = performance.now(); 
        const durationSeconds = ((endTime - startTime) / 1000).toFixed(2);
        let errorMessage = "Error: " + error.message;
        if (error.message.includes("401")) errorMessage = "Authentication failed. Check API Key.";
        else if (error.message.includes("429")) errorMessage = "Rate limit exceeded. Try again later.";
        
        thread.messages[placeholderIndex] = { 
            content: errorMessage, 
            sender: "bot", 
            isPlaceholder: false, 
            timestamp: new Date(), 
            wordCount: 0, 
            enhancedCoD: false,
            durationSeconds: durationSeconds, 
        };
        renderCurrentThreadMessages();
      }
    }
    
    function addCodeCopyButtons() {
      document.querySelectorAll('pre code').forEach(code => {
        if (code.parentElement.classList.contains('relative')) return;
        
        const pre = code.parentElement; 
        const container = document.createElement('div');
        container.className = 'relative mb-4 rounded-lg overflow-hidden'; 
        pre.parentNode.insertBefore(container, pre); 
        container.appendChild(pre);
        
        const language = code.className.match(/language-([^\s]+)/)?.[1];
        if (language && language !== 'plaintext') { 
          const langBadge = document.createElement('div'); 
          langBadge.className = 'absolute top-2 left-2 bg-dark-900/80 text-xs py-1 px-2 rounded text-gray-400'; 
          langBadge.textContent = language; 
          container.appendChild(langBadge); 
        }
        
        pre.className = 'bg-dark-900 rounded-lg p-4 overflow-x-auto text-sm';
        
        const copyBtn = document.createElement('button'); 
        copyBtn.className = 'absolute top-2 right-2 bg-dark-900/80 text-gray-400 hover:text-white text-xs py-1 px-2 rounded transition-colors'; 
        copyBtn.textContent = 'Copy';
        
        copyBtn.addEventListener('click', () => { 
          navigator.clipboard.writeText(code.textContent || '').then(() => { 
            copyBtn.textContent = 'Copied!'; 
            copyBtn.classList.add('text-green-400'); 
            setTimeout(() => { 
              copyBtn.textContent = 'Copy'; 
              copyBtn.classList.remove('text-green-400'); 
            }, 2000); 
          }).catch(() => { 
            copyBtn.textContent = 'Failed'; 
            copyBtn.classList.add('text-red-400'); 
            setTimeout(() => { 
              copyBtn.textContent = 'Copy'; 
              copyBtn.classList.remove('text-red-400'); 
            }, 2000); 
          }); 
        });
        
        container.appendChild(copyBtn);
      });
    }
    
    function toggleWebSearchQuickButton() {
      const btn = document.getElementById('webSearchBtn'); 
      if (!btn) return;
      
      enableWebSearchQuickToggle = !enableWebSearchQuickToggle;
      
      if (enableWebSearchQuickToggle) { 
        btn.classList.add('bg-primary-500', 'text-white'); 
        btn.classList.remove('bg-dark-500', 'text-gray-300'); 
        btn.title = "Tavily Web Search enabled for Enhanced CoD"; 
      } else { 
        btn.classList.remove('bg-primary-500', 'text-white'); 
        btn.classList.add('bg-dark-500', 'text-gray-300'); 
        btn.title = "Tavily Web Search disabled"; 
      }
      
      const tavilyToolCheckbox = document.getElementById('tavilySearchTool');
      if (tavilyToolCheckbox) { 
        tavilyToolCheckbox.checked = enableWebSearchQuickToggle; 
        if (enableWebSearchQuickToggle) { 
          if (!ENABLED_MCP_TOOLS.includes("tavily_search")) {
            ENABLED_MCP_TOOLS.push("tavily_search"); 
          }
        } else { 
          ENABLED_MCP_TOOLS = ENABLED_MCP_TOOLS.filter(t => t !== "tavily_search"); 
        }
      }
      
      localStorage.setItem('enableWebSearchQuickToggle', enableWebSearchQuickToggle.toString()); 
      localStorage.setItem('enabledMcpTools', JSON.stringify(ENABLED_MCP_TOOLS));
      showNotification(enableWebSearchQuickToggle ? 'Tavily search enabled for Enhanced CoD' : 'Tavily search disabled');
    }

    function setupTabNavigation() {
      const tabButtons = document.querySelectorAll('.tab-btn'); 
      const tabContents = document.querySelectorAll('.tab-content');
      
      tabButtons.forEach(button => {
        button.addEventListener('click', () => {
          // Remove active state from all buttons and contents
          tabButtons.forEach(btn => { 
            btn.classList.remove('bg-primary-500', 'text-white'); 
            btn.classList.add('text-gray-400'); 
          });
          tabContents.forEach(content => { 
            content.classList.remove('active'); 
            content.style.display = 'none'; 
          });
          
          // Add active state to clicked button and show corresponding content
          button.classList.add('bg-primary-500', 'text-white'); 
          button.classList.remove('text-gray-400');
          
          const tabId = button.getAttribute('data-tab'); 
          const tabContent = document.getElementById(tabId);
          if (tabContent) { 
            tabContent.classList.add('active'); 
            tabContent.style.display = 'block'; 
          }
        });
      });
    }
    
    function setupSliders() {
      document.querySelectorAll('input[type="range"]').forEach(slider => {
        const valueDisplay = document.getElementById(`${slider.id}Value`);
        if (valueDisplay) { 
          valueDisplay.textContent = slider.value; 
          updateRangeColor(slider); 
          slider.addEventListener('input', () => { 
            valueDisplay.textContent = slider.value; 
            updateRangeColor(slider); 
            
            // Update CoD words per step in real-time
            if (slider.id === 'codWordsPerStep') {
              COD_WORDS_PER_STEP = parseInt(slider.value);
            }
          });
        }
      });
    }
    
    function updateRangeColor(slider) { 
      const min = parseFloat(slider.min) || 0; 
      const max = parseFloat(slider.max) || 1; 
      const value = parseFloat(slider.value) || 0; 
      const percent = ((value - min) / (max - min)) * 100; 
      slider.style.setProperty('--value-percent', `${percent}%`);
    }
    
    function openSettingsModal() {
      // Set current values
      setSliderAndValue("codWordsPerStep", COD_WORDS_PER_STEP);
      setSliderAndValue("temp", TEMPERATURE); 
      setSliderAndValue("topP", TOP_P); 
      setSliderAndValue("topK", TOP_K); 
      setSliderAndValue("maxTokens", MAX_TOKENS);
      
      // Set checkboxes
      document.getElementById('enableProblemDetection').checked = ENABLE_PROBLEM_DETECTION;
      document.getElementById('enableDetailedAnalysis').checked = ENABLE_DETAILED_ANALYSIS;
      document.getElementById('enablePartReflections').checked = ENABLE_PART_REFLECTIONS;
      document.getElementById('enableMetaReflection').checked = ENABLE_META_REFLECTION;
      
      const streamingToggle = document.getElementById('streamingToggle'); 
      if (streamingToggle) streamingToggle.checked = ENABLE_STREAMING;
      
      setupMcpToolsOptions();
      
      const modal = document.getElementById("settingsModal"); 
      if (modal) modal.style.display = "flex";
      
      // Set default tab to CoD Config
      const tabButtons = document.querySelectorAll('.tab-btn'); 
      const tabContents = document.querySelectorAll('.tab-content');
      
      tabContents.forEach(content => { 
        content.classList.remove('active'); 
        content.style.display = 'none'; 
      });
      
      tabButtons.forEach(btn => { 
        btn.classList.remove('bg-primary-500', 'text-white'); 
        btn.classList.add('text-gray-400'); 
      });
      
      const reasoningTabBtn = document.querySelector('.tab-btn[data-tab="reasoningTab"]'); 
      const reasoningTab = document.getElementById('reasoningTab');
      if (reasoningTabBtn && reasoningTab) { 
        reasoningTabBtn.classList.add('bg-primary-500', 'text-white'); 
        reasoningTabBtn.classList.remove('text-gray-400'); 
        reasoningTab.classList.add('active'); 
        reasoningTab.style.display = 'block'; 
      }
    }
    
    function setSliderAndValue(id, value) { 
      const slider = document.getElementById(id); 
      const valueDisplay = document.getElementById(`${id}Value`); 
      if (slider) { 
        slider.value = value; 
        updateRangeColor(slider); 
      } 
      if (valueDisplay) valueDisplay.textContent = value; 
    }
    
    function closeSettingsModal() { 
      const modal = document.getElementById("settingsModal"); 
      if (modal) modal.style.display = "none"; 
    }
    
    function saveSettings() {
      // Enhanced CoD Settings
      COD_WORDS_PER_STEP = parseInt(document.getElementById("codWordsPerStep").value);
      ENABLE_PROBLEM_DETECTION = document.getElementById('enableProblemDetection').checked;
      ENABLE_DETAILED_ANALYSIS = document.getElementById('enableDetailedAnalysis').checked;
      ENABLE_PART_REFLECTIONS = document.getElementById('enablePartReflections').checked;
      ENABLE_META_REFLECTION = document.getElementById('enableMetaReflection').checked;
      
      // Streaming
      const streamingToggle = document.getElementById('streamingToggle'); 
      if (streamingToggle) { 
        ENABLE_STREAMING = streamingToggle.checked; 
        localStorage.setItem('streamingEnabled', ENABLE_STREAMING.toString()); 
      }
      
      // Model Parameters
      TEMPERATURE = parseFloat(document.getElementById("temp").value); 
      if (TEMPERATURE === 0 && document.getElementById("temp").min === "0") TEMPERATURE = 0.01;
      TOP_P = parseFloat(document.getElementById("topP").value); 
      TOP_K = parseInt(document.getElementById("topK").value); 
      MAX_TOKENS = parseInt(document.getElementById("maxTokens").value);
      
      // Tools
      ENABLED_MCP_TOOLS = []; 
      document.querySelectorAll('input[name="mcp_tools"]').forEach(checkbox => { 
        if (checkbox.checked) ENABLED_MCP_TOOLS.push(checkbox.value); 
      });
      
      if (ENABLED_MCP_TOOLS.includes("tavily_search")) {
        enableWebSearchQuickToggle = true; 
      } else {
        enableWebSearchQuickToggle = false;
      }
      
      // Save to localStorage
      localStorage.setItem("codWordsPerStep", COD_WORDS_PER_STEP.toString());
      localStorage.setItem("enableProblemDetection", ENABLE_PROBLEM_DETECTION.toString());
      localStorage.setItem("enableDetailedAnalysis", ENABLE_DETAILED_ANALYSIS.toString());
      localStorage.setItem("enablePartReflections", ENABLE_PART_REFLECTIONS.toString());
      localStorage.setItem("enableMetaReflection", ENABLE_META_REFLECTION.toString());
      localStorage.setItem("temperature", TEMPERATURE.toString()); 
      localStorage.setItem("topP", TOP_P.toString()); 
      localStorage.setItem("topK", TOP_K.toString()); 
      localStorage.setItem("maxTokens", MAX_TOKENS.toString()); 
      localStorage.setItem("enabledMcpTools", JSON.stringify(ENABLED_MCP_TOOLS)); 
      localStorage.setItem("enableWebSearchQuickToggle", enableWebSearchQuickToggle.toString());
      
      updateWebSearchButtonAppearance(); 
      closeSettingsModal(); 
      showNotification("Enhanced CoD settings saved");
    }
    
    function setupMcpToolsOptions() {
      const toolCheckboxes = document.querySelectorAll('input[name="mcp_tools"]');
      toolCheckboxes.forEach(checkbox => {
        const toolName = checkbox.value; 
        checkbox.checked = ENABLED_MCP_TOOLS.includes(toolName) || (toolName === "tavily_search" && enableWebSearchQuickToggle);
        
        checkbox.addEventListener('change', () => {
          if (checkbox.checked) { 
            if (!ENABLED_MCP_TOOLS.includes(toolName)) {
              ENABLED_MCP_TOOLS.push(toolName); 
            }
            if (toolName === "tavily_search") {
              enableWebSearchQuickToggle = true; 
            }
          } else { 
            ENABLED_MCP_TOOLS = ENABLED_MCP_TOOLS.filter(tool => tool !== toolName); 
            if (toolName === "tavily_search") {
              enableWebSearchQuickToggle = false; 
            }
          }
          localStorage.setItem('enabledMcpTools', JSON.stringify(ENABLED_MCP_TOOLS)); 
          localStorage.setItem('enableWebSearchQuickToggle', enableWebSearchQuickToggle.toString()); 
          updateWebSearchButtonAppearance();
        });
      });
    }
    
    function updateWebSearchButtonAppearance() {
      const btn = document.getElementById('webSearchBtn'); 
      if (!btn) return;
      
      if (enableWebSearchQuickToggle) { 
        btn.classList.add('bg-primary-500', 'text-white'); 
        btn.classList.remove('bg-dark-500', 'text-gray-300'); 
        btn.title = "Tavily Web Search enabled for Enhanced CoD"; 
      } else { 
        btn.classList.remove('bg-primary-500', 'text-white'); 
        btn.classList.add('bg-dark-500', 'text-gray-300'); 
        btn.title = "Tavily Web Search disabled"; 
      }
    }
    
    function initMobileNavigation() {
      const mobileSidebarToggle = document.getElementById('mobileSidebarToggle'); 
      const mobileSidebar = document.getElementById('mobileSidebar'); 
      const closeMobileSidebar = document.getElementById('closeMobileSidebar');
      
      if (mobileSidebarToggle && mobileSidebar) {
        mobileSidebarToggle.addEventListener('click', () => { 
          mobileSidebar.classList.remove('-translate-x-full'); 
          mobileSidebar.classList.add('translate-x-0'); 
        });
      }
      
      if (closeMobileSidebar && mobileSidebar) {
        closeMobileSidebar.addEventListener('click', () => { 
          mobileSidebar.classList.remove('translate-x-0'); 
          mobileSidebar.classList.add('-translate-x-full'); 
        });
      }
      
      document.getElementById('mobileNewThreadBtn')?.addEventListener('click', () => { 
        createNewThread(); 
        mobileSidebar.classList.remove('translate-x-0'); 
        mobileSidebar.classList.add('-translate-x-full'); 
      });
      
      document.getElementById('mobileDeleteThreadBtn')?.addEventListener('click', () => { 
        deleteCurrentThread(); 
        mobileSidebar.classList.remove('translate-x-0'); 
        mobileSidebar.classList.add('-translate-x-full'); 
      });
      
      document.getElementById('mobileDownloadTxtBtn')?.addEventListener('click', () => { 
        downloadCurrentThreadAsTxt(); 
        mobileSidebar.classList.remove('translate-x-0'); 
        mobileSidebar.classList.add('-translate-x-full'); 
      });
      
      document.getElementById('mobileClearThreadBtn')?.addEventListener('click', () => { 
        if (confirm("Clear all messages in this thread?")) { 
          const thread = threads.find(t => t.id === currentThreadId); 
          if (thread) { 
            thread.messages = []; 
            renderCurrentThreadMessages(); 
            showNotification("Thread cleared"); 
          }
        } 
        mobileSidebar.classList.remove('translate-x-0'); 
        mobileSidebar.classList.add('-translate-x-full'); 
      });
    }
    
    function loadPersistedSettings() {
      // Enhanced CoD Settings
      const codWords = localStorage.getItem("codWordsPerStep"); 
      if (codWords) COD_WORDS_PER_STEP = parseInt(codWords);
      
      const problemDetection = localStorage.getItem("enableProblemDetection"); 
      if (problemDetection !== null) ENABLE_PROBLEM_DETECTION = problemDetection === "true";
      
      const detailedAnalysis = localStorage.getItem("enableDetailedAnalysis"); 
      if (detailedAnalysis !== null) ENABLE_DETAILED_ANALYSIS = detailedAnalysis === "true";
      
      const partReflections = localStorage.getItem("enablePartReflections"); 
      if (partReflections !== null) ENABLE_PART_REFLECTIONS = partReflections === "true";
      
      const metaReflection = localStorage.getItem("enableMetaReflection"); 
      if (metaReflection !== null) ENABLE_META_REFLECTION = metaReflection === "true";
      
      // Model Parameters
      const temp = localStorage.getItem("temperature"); 
      if (temp) TEMPERATURE = parseFloat(temp);
      
      const topP = localStorage.getItem("topP"); 
      if (topP) TOP_P = parseFloat(topP);
      
      const topK = localStorage.getItem("topK"); 
      if (topK) TOP_K = parseInt(topK);
      
      const maxTokens = localStorage.getItem("maxTokens"); 
      if (maxTokens) MAX_TOKENS = parseInt(maxTokens);
      
      const streaming = localStorage.getItem('streamingEnabled'); 
      if (streaming !== null) ENABLE_STREAMING = streaming === 'true';
      
      // Tools
      const mcpTools = localStorage.getItem('enabledMcpTools'); 
      if (mcpTools) { 
        try { 
          ENABLED_MCP_TOOLS = JSON.parse(mcpTools); 
        } catch(e) { 
          ENABLED_MCP_TOOLS = []; 
        }
      }
      
      const webSearchToggle = localStorage.getItem('enableWebSearchQuickToggle'); 
      if (webSearchToggle !== null) enableWebSearchQuickToggle = webSearchToggle === 'true';
    }
    
    function initApp() { 
      loadPersistedSettings(); 
      createNewThread(); 
      initEventListeners(); 
      initMobileNavigation(); 
      updateWebSearchButtonAppearance(); 
      
      // Show welcome message about Enhanced CoD
      setTimeout(() => {
        showNotification("Enhanced Chain of Draft ready! Try a complex math, coding, or logic problem.", 5000);
      }, 1000);
    }
    
    function initEventListeners() {
      const addListener = (id, event, handler) => { 
        const element = document.getElementById(id); 
        if (element) {
          element.addEventListener(event, handler); 
        } else {
          console.warn(`Element "${id}" not found`); 
        }
      };
      
      addListener("openSettings", "click", openSettingsModal); 
      addListener("closeSettings", "click", closeSettingsModal); 
      addListener("closeModalX", "click", closeSettingsModal); 
      addListener("saveSettings", "click", saveSettings);
      
      addListener("newThreadBtn", "click", createNewThread); 
      addListener("deleteThreadBtn", "click", deleteCurrentThread); 
      addListener("downloadTxtBtn", "click", downloadCurrentThreadAsTxt);
      
      addListener("clearThreadBtn", "click", () => { 
        if (confirm("Clear messages?")) { 
          const thread = threads.find(t => t.id === currentThreadId); 
          if (thread) { 
            thread.messages = []; 
            renderCurrentThreadMessages(); 
            showNotification("Thread cleared"); 
          }
        }
      });
      
      addListener("webSearchBtn", "click", toggleWebSearchQuickButton);
      
      const textarea = document.getElementById('userInput');
      if (textarea) { 
        textarea.addEventListener('input', () => { 
          textarea.style.height = 'auto'; 
          textarea.style.height = (textarea.scrollHeight) + 'px'; 
        }); 
        
        textarea.addEventListener('keydown', (e) => { 
          if (e.key === 'Enter' && !e.shiftKey) { 
            e.preventDefault(); 
            document.getElementById('sendBtn')?.click(); 
          }
        });
      }
      
      addListener("sendBtn", "click", () => { 
        const textarea = document.getElementById('userInput'); 
        if (textarea) { 
          const message = textarea.value.trim(); 
          if (message || attachedFiles.length > 0) { 
            sendMessage(message); 
            textarea.value = ''; 
            textarea.style.height = 'auto'; 
          }
        }
      });
      
      handleFileInput();
      
      window.addEventListener("click", (event) => { 
        const settingsModal = document.getElementById("settingsModal"); 
        if (settingsModal && event.target === settingsModal) {
          closeSettingsModal(); 
        }
      });
      
      setTimeout(() => { 
        setupTabNavigation(); 
        setupSliders(); 
      }, 100);
    }
    
    document.addEventListener("DOMContentLoaded", async function() {
      if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.documentElement.classList.add('dark');
      }
      
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => { 
        if (event.matches) {
          document.documentElement.classList.add('dark'); 
        } else {
          document.documentElement.classList.remove('dark'); 
        }
      });
      
      initApp();
    });
  </script>
</body>
</html>
